<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Prep Dashboard</title>

    <style>
        @font-face {
            font-family: 'Century Gothic';
            src: local('Century Gothic'),
                 url('https://fonts.cdnfonts.com/s/7295/CenturyGothic.woff') format('woff'),
                 url('https://fonts.cdnfonts.com/s/7295/CenturyGothic.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Century Gothic';
            src: local('Century Gothic Bold'),
                 url('https://fonts.cdnfonts.com/s/7295/CenturyGothic-Bold.woff') format('woff'),
                 url('https://fonts.cdnfonts.com/s/7295/CenturyGothic-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
    </style>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <style>
        body {
            font-family: 'Century Gothic', sans-serif; /* Apply Century Gothic globally */
            background-color: #f5f5f5; /* Light grey background */
        }
        .navbar-fixed {
            margin-bottom: 30px;
        }
        .brand-logo {
            font-weight: bold; /* Make logo bold as Century Gothic regular can be thin */
            letter-spacing: 0.5px;
        }
        .container {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .card-title {
            font-weight: bold; /* Century Gothic looks better bold for titles */
            color: #263238; /* Darker title color */
            border-bottom: 1px solid #eceff1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .collection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .collection-item:last-child {
            border-bottom: none;
        }
        .collection-item .title {
            font-weight: bold;
            color: #424242;
        }
        .collection-item p {
            margin: 0;
            font-size: 0.9em;
            color: #757575;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        .status-PENDING { background-color: #ffb300; } /* Amber */
        .status-IN_PROGRESS { background-color: #00bcd4; } /* Cyan */
        .status-READY { background-color: #43a047; } /* Green */
        .status-ERROR { background-color: #e53935; } /* Red */

        .department-card .card-content {
            padding-bottom: 10px;
        }
        .department-card h5 {
            font-weight: bold;
            color: #673ab7; /* Deep Purple */
            margin-bottom: 10px;
        }
        .tool-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .tool-list li i {
            margin-right: 8px;
            color: #4caf50; /* Green for check icon */
        }
        .tool-list .optional {
            color: #757575; /* Grey for optional */
            font-style: italic;
        }
        .tool-list .optional i {
            color: #9e9e9e; /* Lighter grey for optional icon */
        }
        .tool-list .optional::after {
            content: ' (Optional)';
            font-style: normal; /* Override italic for ' (Optional)' part */
        }
        .machine-actions {
            margin-top: 10px;
            text-align: right; /* Align buttons to the right */
        }
        .chip {
            background-color: #e0e0e0;
            color: #424242;
            font-size: 0.8em;
            height: 28px;
            line-height: 28px;
            padding: 0 12px;
            border-radius: 14px;
            display: inline-block;
        }
        .chip i {
            font-size: 1em;
            height: 28px;
            line-height: 28px;
            float: left;
            margin-right: 8px;
        }
        /* Style for the select dropdown */
        .department-select {
            display: block; /* Make it take full width of its container */
            width: 100%;
            padding: 8px 12px;
            font-size: 0.9em;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            margin-top: 5px; /* Space between label and select */
            -webkit-appearance: none; /* Remove default browser styling for select */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20512%22%3E%3Cpath%20fill%3D%22%23424242%22%20d%3D%22M192%20416c-8.18%200-16.35-3.12-22.63-9.37L52.63%20256%20169.37%209.37c12.5-12.5%2032.76-12.5%2045.26%200s12.5%2032.76%200%2045.26L138.7%20256l77.93%2077.93c12.5%2012.5%2012.5%2032.76%200%2045.26-6.25%206.25-14.42%209.37-22.6%209.37z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: pointer;
        }
        /* Override Materialize default select styling as it can be tricky with dynamic content */
        .browser-default {
            display: block !important;
        }
        /* Modal specific styles */
        #machineDetailsModal .modal-content {
            padding: 24px;
        }
        #machineDetailsModal h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: bold; /* Century Gothic looks better bold for titles */
        }
        #modalRequiredToolsList li {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        #modalRequiredToolsList li i {
            margin-right: 8px;
            color: #4CAF50; /* Green checkmark */
        }
        #modalRequiredToolsList li .tool-description {
            font-size: 0.9em;
            color: #757575;
            margin-left: 5px;
        }

        /* --- REFINED STYLES FOR OPTIONAL TOOLS LIST IN MODAL (Alignment Fix) --- */
        #modalToolsList .tool-item {
            display: flex;
            align-items: flex-start; /* Align checkbox and content at the top */
            margin-bottom: 10px;
            padding-left: 0;
        }
        #modalToolsList .tool-item label {
            display: flex;
            align-items: flex-start;
            width: 100%;
            cursor: default;
        }
        /* Adjust Materialize checkbox margin to align with text top */
        #modalToolsList .tool-item label > input[type="checkbox"] {
            margin-top: 10px; /* Aligns checkbox with the top of the name */
            margin-right: 15px; /* Space between checkbox and text */
            position: relative;
            z-index: 1;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
        /* Style for the visual part of the Materialize checkbox */
        #modalToolsList .tool-item label > span {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            line-height: normal;
            padding-top: 8px; /* Adjust padding to vertically align content with checkbox */
        }
        #modalToolsList .tool-item .tool-name-and-badge {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 3px;
        }
        #modalToolsList .tool-item .tool-name-text {
            font-weight: bold; /* Make tool names bold */
            color: #424242;
            line-height: 1.2;
            flex-grow: 1; /* Allow name to take available space */
        }
        #modalToolsList .tool-item .tool-description {
            font-size: 0.85em;
            color: #757575;
            line-height: 1.4;
            margin-top: 0;
            display: block;
        }
        /* Custom Badge for "From Dept" to avoid Materialize overlap */
        .custom-badge-from-dept {
            background-color: #ef5350; /* Red background, consistent with logout */
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 10px; /* Space between tool name and badge */
            white-space: nowrap;
            flex-shrink: 0;
            line-height: 1;
        }
        /* Disable visual effects for disabled checkboxes */
        #modalToolsList .tool-item input[type="checkbox"][disabled] + span:not(.lever):before,
        #modalToolsList .tool-item input[type="checkbox"][disabled] + span:not(.lever):after {
            border-color: #9e9e9e !important;
            background-color: #e0e0e0 !important;
        }
        #modalToolsList .tool-item input[type="checkbox"][disabled]:checked + span:not(.lever):before {
            background-color: #757575 !important; /* Darker grey for checked disabled */
            border-color: #757575 !important;
        }
        #modalToolsList .tool-item input[type="checkbox"][disabled] + span:not(.lever) {
            color: #9e9e9e !important; /* Grey out the label text */
        }

        .modal-footer {
            padding: 15px 24px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Checklist specific styles */
        .checklist-item-card {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fcfcfc;
        }
        .checklist-item-card h6 {
            margin-top: 0;
            margin-bottom: 8px;
            font-weight: bold; /* Make checklist item titles bold */
            color: #333;
        }
        .checklist-item-card p.description {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #757575;
        }
        .checklist-item-card .input-field {
            margin-top: 0;
            margin-bottom: 0;
        }
        .checklist-item-card .input-field label {
            top: 0.8rem;
        }
        .checklist-item-card .input-field select {
            display: block;
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            height: 3rem;
        }
        .checklist-item-card textarea.materialize-textarea {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: auto;
            min-height: 45px;
            line-height: 1.5;
            overflow-y: auto;
        }
        /* Style for disabled select/textarea */
        .checklist-item-card select:disabled,
        .checklist-item-card textarea:disabled {
            background-color: #eeeeee;
            cursor: not-allowed;
        }
        /* Ensure labels for selects/textareas don't overlap initial content */
        .checklist-item-card .input-field label.active {
            transform: translateY(-14px) scale(0.8);
            transform-origin: 0 0;
        }

        /* Custom style for the Logout button form container */
        .logout-form {
            display: inline-block; /* Allows the form to sit nicely in the navbar li */
            margin-left: 15px; /* Space from other navbar items */
        }
        .logout-form button {
            background-color: #ef5350 !important; /* Materialize Red accent-2 */
            padding: 0 15px; /* Adjust padding for button look */
            height: 36px; /* Standard button height */
            line-height: 36px; /* Center text vertically */
            border-radius: 4px; /* Slightly rounded corners */
            border: none; /* Remove default button border */
            cursor: pointer; /* Indicate it's clickable */
            display: flex; /* Use flex to align icon and text */
            align-items: center; /* Vertically center icon and text */
            justify-content: center; /* Horizontally center icon and text */
            color: white; /* Text color */
            font-weight: bold; /* Make text bold */
            text-transform: uppercase; /* Match Materialize button style */
            font-family: 'Century Gothic', sans-serif; /* Ensure Century Gothic for button text */
            letter-spacing: 0.5px;
        }
        .logout-form button:hover {
            background-color: #d32f2f !important; /* Darker red on hover */
        }
        .logout-form button i {
            margin-right: 8px; /* Space between icon and text */
            font-size: 1.2em; /* Slightly larger icon */
        }

        /* --- Mobile Responsiveness for Navbar & Logout Button --- */
        @media only screen and (max-width: 992px) {
            nav .brand-logo {
                left: 50%;
                transform: translateX(-50%);
            }
            nav .sidenav-trigger {
                display: block; /* Show hamburger icon */
            }
            .sidenav {
                background-color: #673ab7; /* Deep Purple background for sidenav */
            }
            .sidenav li > a {
                color: #fff; /* White text for sidenav links */
                font-weight: bold;
                padding: 0 32px; /* Add some padding */
            }
            .sidenav li > a:hover {
                background-color: #5e35b1; /* Darker purple on hover */
            }
            .sidenav .user-view {
                padding: 32px 32px 0;
                margin-bottom: 20px;
            }
            .sidenav .user-view .name, .sidenav .user-view .email {
                font-weight: bold;
                color: white;
            }
            /* Style for the logout button form in the sidenav */
            .sidenav .logout-form-sidenav {
                margin: 20px 32px; /* Center the button, add vertical space */
                width: calc(100% - 64px); /* Full width minus horizontal margin */
                text-align: center;
            }
            .sidenav .logout-form-sidenav button {
                width: 100%; /* Make the button inside the form full width */
                font-size: 1.1em; /* Slightly larger text for mobile button */
                padding: 10px 15px; /* More padding for a larger touch target */
                height: auto; /* Allow height to adjust to padding */
            }
        }
    </style>
</head>
<body>
    <div class="navbar-fixed">
        <nav class="deep-purple darken-1">
            <div class="nav-wrapper container">
                <a href="#" class="brand-logo">System Prep Dashboard</a>
                <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a href="#machines"><i class="material-icons left">desktop_windows</i> Machines</a></li>
                    <li><a href="#departments"><i class="material-icons left">business</i> Departments</a></li>
                    <li>
                        <form method="post" action="{% url 'logout' %}" class="logout-form">
                            {% csrf_token %}
                            <button type="submit" class="waves-effect waves-light btn btn-small">
                                <i class="material-icons left">power_settings_new</i> Logout
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <ul class="sidenav" id="mobile-demo">
        <li><div class="user-view">
            <div class="background" style="background: linear-gradient(135deg, #8e24aa, #5e35b1);">
                </div>
            <a href="#user"><img class="circle" src="https://via.placeholder.com/64/000000/FFFFFF?text=AD"></a> <a href="#name"><span class="white-text name">Admin User</span></a> <a href="#email"><span class="white-text email">admin@yourdomain.com</span></a> </div></li>
        <li><a href="#machines"><i class="material-icons">desktop_windows</i> Machines</a></li>
        <li><a href="#departments"><i class="material-icons">business</i> Departments</a></li>
        <li><div class="divider"></div></li>
        <li>
            <form method="post" action="{% url 'logout' %}" class="logout-form-sidenav">
                {% csrf_token %}
                <button type="submit" class="waves-effect waves-light btn btn-large">
                    <i class="material-icons left">power_settings_new</i> Logout
                </button>
            </form>
        </li>
    </ul>

    <div class="container">
        <div class="row">
            <div class="col s12 m8 offset-m2 l6 offset-l3">
                <p class="right-align grey-text text-darken-1" style="font-size: 0.9em;">
                    <i class="material-icons tiny">access_time</i> Last updated: {{ current_time|date:"F j, Y, H:i:s" }}
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Machine Onboarding</span>
                        <p>Download the client agent script to register a new workstation with the system.</p>
                        <br>
                        <a href="{% url 'download_agent_exe' %}" class="waves-effect waves-light btn deep-purple darken-1">
                            <i class="material-icons left">file_download</i> Download Agent Script
                        </a>
                        <p class="grey-text text-darken-1" style="margin-top: 15px; font-size: 0.9em;">
                            * Remember to replace `API_KEY` in the downloaded script with your actual API Key for each machine for better security and management.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="machines">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Registered Machines ({{ machines|length }})</span>
                        <div class="collection">
                            {% for machine in machines %}
                                <div class="collection-item">
                                    <div>
                                        <span class="title">
                                            <i class="material-icons tiny left">computer</i>
                                            {{ machine.hostname }}
                                        </span>
                                        <p>
                                            IP: {{ machine.ip_address|default:"N/A" }} <br>
                                            <label for="department_select_{{ machine.id }}">Department:</label>
                                            <select id="department_select_{{ machine.id }}"
                                                    class="browser-default department-select"
                                                    data-machine-id="{{ machine.id }}">
                                                <option value="" disabled {% if not machine.department %}selected{% endif %}>Select Department</option>
                                                {% for department in departments %}
                                                    <option value="{{ department.id }}" {% if machine.department.id == department.id %}selected{% endif %}>
                                                        {{ department.name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            {% if machine.is_lead %}
                                                <span class="chip deep-purple lighten-4 deep-purple-text text-darken-3"><i class="fas fa-crown"></i> Lead</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="secondary-content">
                                        <span class="status-badge status-{{ machine.overall_status }}">
                                            {{ machine.get_overall_status_display }}
                                        </span>
                                        <div class="machine-actions">
                                            <a href="#machineDetailsModal"
                                               class="waves-effect waves-light btn-small light-blue darken-1 modal-trigger"
                                               data-machine-id="{{ machine.id }}"
                                               data-machine-hostname="{{ machine.hostname }}"
                                               data-department-tools='[
                                                {% for tool in machine.department.productivity_tools.all %}
                                                    {
                                                        "id": {{ tool.id }},
                                                        "name": "{{ tool.name|escapejs }}",
                                                        "description": "{{ tool.description|escapejs }}",
                                                        "is_optional": {{ tool.optional|yesno:"true,false" }}
                                                    }{% if not forloop.last %},{% endif %}
                                                {% endfor %}
                                               ]'
                                               data-optional-tools='[
                                                {% for tool in machine.optional_tools.all %}
                                                    {"id": {{ tool.id }}}{% if not forloop.last %},{% endif %}
                                                {% endfor %}
                                               ]'
                                               data-machine-checklist-statuses='[
                                                {% for status in machine.machine_checklist_statuses_prefetched %}
                                                    {
                                                        "id": {{ status.id }},
                                                        "checklist_item_id": {{ status.checklist_item.id }},
                                                        "status": "{{ status.status|escapejs }}",
                                                        "notes": "{{ status.notes|escapejs }}"
                                                    }{% if not forloop.last %},{% endif %}
                                                {% endfor %}
                                               ]'>
                                               <i class="material-icons left">assignment</i> View Details
                                           </a>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="collection-item center-align grey-text">
                                    <i class="material-icons large">sentiment_dissatisfied</i>
                                    <h5>No machines registered yet.</h5>
                                    <p>Run the client agent script on a workstation to register it.</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="departments">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Departments & Default Tools ({{ departments|length }})</span>
                        <div class="row">
                            {% for department in departments %}
                                <div class="col s12 m6 l4">
                                    <div class="card department-card grey lighten-5 z-depth-0" style="border: 1px solid #e0e0e0;">
                                        <div class="card-content">
                                            <h5><i class="material-icons tiny left">group</i> {{ department.name }}</h5>
                                            <p class="grey-text text-darken-1">{{ department.description|default:"No description provided." }}</p>
                                            <h6 style="margin-top: 15px; border-top: 1px dashed #e0e0e0; padding-top: 10px;">Productivity Tools:</h6>
                                            <ul class="tool-list">
                                                {% for tool in department.productivity_tools.all %}
                                                    <li {% if tool.optional %}class="optional"{% endif %}>
                                                        <i class="fas fa-check-circle"></i> {{ tool.name }}
                                                    </li>
                                                {% empty %}
                                                    <li class="grey-text">No default tools assigned.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="machineDetailsModal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4 id="modalMachineHostname">Machine Details: </h4>
            <div class="row">
                <div class="col s12">
                    <h5>Required Tools (from Department)</h5>
                    <ul id="modalRequiredToolsList">
                        </ul>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <h5>Optional Tools (Select to Assign)</h5>
                    <div id="modalToolsList">
                        </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <h5>Checklist Statuses</h5>
                    <div id="modalChecklistStatus">
                        </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
            <button class="btn waves-effect waves-light deep-purple darken-1" id="saveOptionalToolsBtn">
                Save Optional Tools
                <i class="material-icons right">send</i>
            </button>
            <button class="btn waves-effect waves-light cyan darken-1" id="saveChecklistStatusBtn" style="margin-left: 10px;">
                Save Checklist Statuses
                <i class="material-icons right">check</i>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Materialize Auto Initialization for components
            M.AutoInit();

            // Initialize Sidenav
            var elems = document.querySelectorAll('.sidenav');
            var instances = M.Sidenav.init(elems);

            // Function to get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            // --- Department Assignment Logic ---
            document.querySelectorAll('.department-select').forEach(selectElement => {
                selectElement.addEventListener('change', function() {
                    const machineId = this.dataset.machineId;
                    const selectedDepartmentId = this.value;

                    const apiUrl = `/api/machine/${machineId}/assign_department/`;

                    fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken, // CSRF token for department assignment
                        },
                        body: JSON.stringify({ department_id: selectedDepartmentId })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || `HTTP error! Status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        M.toast({html: `Department assigned to ${data.hostname} successfully!`, classes: 'green darken-1'});
                        // Refresh the page to show the updated department tools
                        setTimeout(() => location.reload(), 1500);
                    })
                    .catch(error => {
                        console.error('Error assigning department:', error);
                        M.toast({html: `Error: ${error.message || 'Failed to assign department.'}`, classes: 'red darken-1'});
                    });
                });
            });

            // --- Optional Tools & Checklist Modal Logic ---
            const machineDetailsModal = document.getElementById('machineDetailsModal');
            const modalMachineHostname = document.getElementById('modalMachineHostname');
            const modalRequiredToolsList = document.getElementById('modalRequiredToolsList');
            const modalToolsList = document.getElementById('modalToolsList');
            const saveOptionalToolsBtn = document.getElementById('saveOptionalToolsBtn');

            // NEW: Checklist elements
            const modalChecklistStatus = document.getElementById('modalChecklistStatus');
            const saveChecklistStatusBtn = document.getElementById('saveChecklistStatusBtn');

            let currentMachineId = null; // Store the ID of the machine currently in the modal

            // Fetch all optional tools available in the system (once on page load)
            let allOptionalTools = [];
            fetch('/api/tools/optional_list/')
                .then(response => response.json())
                .then(data => {
                    allOptionalTools = data;
                })
                .catch(error => console.error('Error fetching all optional tools:', error));

            // NEW: Fetch all checklist items available in the system (once on page load)
            let allChecklistItems = [];
            const CHECKLIST_STATUS_CHOICES = [ // Define these for the dropdowns
                { value: 'PENDING', display: 'Pending' },
                { value: 'IN_PROGRESS', display: 'In Progress' },
                { value: 'COMPLETED', display: 'Completed' },
                { value: 'N_A', display: 'Not Applicable' }
            ];

            fetch('/api/checklist/items/')
                .then(response => response.json())
                .then(data => {
                    allChecklistItems = data;
                })
                .catch(error => console.error('Error fetching all checklist items:', error));


            document.querySelectorAll('.modal-trigger').forEach(trigger => {
                trigger.addEventListener('click', function() {
                    currentMachineId = this.dataset.machineId;
                    const machineHostname = this.dataset.machineHostname;
                    const departmentTools = JSON.parse(this.dataset.departmentTools);
                    const optionalTools = JSON.parse(this.dataset.optionalTools).map(t => t.id); // Get IDs
                    // NEW: Parse machine's current checklist statuses
                    const machineChecklistStatuses = JSON.parse(this.dataset.machineChecklistStatuses);
                    const machineChecklistMap = new Map();
                    machineChecklistStatuses.forEach(status => {
                        machineChecklistMap.set(status.checklist_item_id, status);
                    });

                    modalMachineHostname.textContent = `Machine Details: ${machineHostname}`;

                    // Populate Required Tools (from department)
                    modalRequiredToolsList.innerHTML = '';
                    if (departmentTools.length > 0) {
                        departmentTools.forEach(tool => {
                            const li = document.createElement('li');
                            li.innerHTML = `<i class="fas fa-check-circle"></i> ${tool.name} <span class="grey-text text-darken-1 tool-description">${tool.description}</span>`;
                            modalRequiredToolsList.appendChild(li);
                        });
                    } else {
                        modalRequiredToolsList.innerHTML = '<li>No default tools for this department.</li>';
                    }

                    // Populate Optional Tools (all optional tools with checkboxes)
                    modalToolsList.innerHTML = '';
                    if (allOptionalTools.length > 0) {
                        allOptionalTools.forEach(tool => {
                            const div = document.createElement('div');
                            div.classList.add('tool-item');
                            const isChecked = optionalTools.includes(tool.id) || (departmentTools.some(dt => dt.id === tool.id && dt.is_optional));
                            const isDisabled = departmentTools.some(dt => dt.id === tool.id && dt.is_optional);

                            div.innerHTML = `
                                <label style="display: flex; align-items: flex-start; margin-bottom: 0;">
                                    <input type="checkbox"
                                           class="filled-in optional-tool-checkbox"
                                           data-tool-id="${tool.id}"
                                           ${isChecked ? 'checked' : ''}
                                           ${isDisabled ? 'disabled' : ''} />
                                    <span style="flex-grow: 1; margin-left: 10px;">
                                        <div class="tool-name-and-badge">
                                            <span class="tool-name-text">${tool.name}</span>
                                            ${isDisabled ? '<span class="custom-badge-from-dept">From Dept</span>' : ''}
                                        </div>
                                        <span class="tool-description">${tool.description}</span>
                                    </span>
                                </label>
                            `;
                            modalToolsList.appendChild(div);
                        });
                    } else {
                        modalToolsList.innerHTML = '<p class="grey-text">No optional tools available in the system.</p>';
                    }

                    // Populate Checklist Statuses
                    modalChecklistStatus.innerHTML = '';
                    if (allChecklistItems.length > 0) {
                        allChecklistItems.forEach(item => {
                            const currentStatus = machineChecklistMap.get(item.id);
                            const statusValue = currentStatus ? currentStatus.status : 'PENDING';
                            const notesValue = currentStatus ? currentStatus.notes : '';

                            const div = document.createElement('div');
                            div.classList.add('checklist-item-card');
                            div.dataset.checklistItemId = item.id;

                            const isChecklistDisabled = false;

                            let statusOptionsHtml = '';
                            CHECKLIST_STATUS_CHOICES.forEach(choice => {
                                statusOptionsHtml += `<option value="${choice.value}" ${statusValue === choice.value ? 'selected' : ''}>${choice.display}</option>`;
                            });

                            div.innerHTML = `
                                <h6>${item.name} ${item.is_critical ? '<span class="new badge red" data-badge-caption="Critical"></span>' : ''}</h6>
                                <p class="description">${item.description || 'No description.'}</p>
                                <div class="row">
                                    <div class="input-field col s12 m6">
                                        <select class="browser-default checklist-status-select" data-checklist-item-id="${item.id}" ${isChecklistDisabled ? 'disabled' : ''}>
                                            ${statusOptionsHtml}
                                        </select>
                                        <label class="active">Status</label>
                                    </div>
                                    <div class="input-field col s12 m6">
                                        <textarea id="notes_item_${item.id}" class="materialize-textarea checklist-notes" data-checklist-item-id="${item.id}" ${isChecklistDisabled ? 'disabled' : ''}>${notesValue}</textarea>
                                        <label for="notes_item_${item.id}">Notes</label>
                                    </div>
                                </div>
                            `;
                            modalChecklistStatus.appendChild(div);

                            // Trigger Materialize textarea auto-resize if needed
                            M.textareaAutoResize(div.querySelector('.checklist-notes'));
                        });
                    } else {
                        modalChecklistStatus.innerHTML = '<p class="grey-text">No checklist items defined in the system.</p>';
                    }
                });
            });

            // Handle Save Optional Tools button click
            saveOptionalToolsBtn.addEventListener('click', function() {
                if (!currentMachineId) return;

                const selectedToolIds = [];
                modalToolsList.querySelectorAll('.optional-tool-checkbox:checked:not([disabled])').forEach(checkbox => {
                    selectedToolIds.push(parseInt(checkbox.dataset.toolId));
                });

                const apiUrl = `/api/machine/${currentMachineId}/optional_tools/`;

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ optional_tool_ids: selectedToolIds })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || `HTTP error! Status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    M.toast({html: `Optional tools updated for ${data.hostname} successfully!`, classes: 'green darken-1'});
                    // Refresh the page to reflect changes.
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    console.error('Error updating optional tools:', error);
                    M.toast({html: `Error: ${error.message || 'Failed to update optional tools.'}`, classes: 'red darken-1'});
                });
            });

            // Handle Save Checklist Statuses button click
            saveChecklistStatusBtn.addEventListener('click', function() {
                if (!currentMachineId) return;

                const checklistUpdates = [];
                modalChecklistStatus.querySelectorAll('.checklist-item-card').forEach(itemCard => {
                    const checklistItemId = parseInt(itemCard.dataset.checklistItemId);
                    const statusSelect = itemCard.querySelector('.checklist-status-select');
                    const notesTextarea = itemCard.querySelector('.checklist-notes');

                    const notes = notesTextarea.value || "";

                    checklistUpdates.push({
                        checklist_item_id: checklistItemId,
                        status: statusSelect.value,
                        notes: notes
                    });
                });

                const apiUrl = `/api/machine/${currentMachineId}/checklist_status/`;

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ checklist_statuses: checklistUpdates })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error('Django Error Response:', err);
                            throw new Error(err.detail || JSON.stringify(err) || `HTTP error! Status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    M.toast({html: `Checklist statuses updated for ${currentMachineId} successfully!`, classes: 'cyan darken-1'});
                    // Refresh the page to reflect changes.
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    console.error('Error updating checklist statuses:', error);
                    M.toast({html: `Error: ${error.message || 'Failed to update checklist statuses.'}`, classes: 'red darken-1'});
                });

                M.Modal.getInstance(machineDetailsModal).close();
            });

        });
    </script>
</body>
</html>